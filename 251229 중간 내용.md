# 📑 Private Team Note Service 설계서 (v1.0)

본 문서는 Git 기반의 이력 관리와 Elasticsearch의 검색 성능을 결합한 사내 전용 업무 관리 서비스의 아키텍처를 정의합니다.

---

## 1. 시스템 아키텍처 개요

본 서비스는 데이터의 신뢰성(Git), 탐색 효율(ES), **운영 안정성(Prefect)**을 3대 핵심 가치로 삼습니다.

- **API Layer:** FastAPI (비동기 처리 및 현대적 API 제공)
- **Database:** SQLite (PoC 단계) → PostgreSQL/Oracle (운영 단계)
- **Version Control:** Git (파일 기반 원본 저장 및 수정 이력 관리)
- **Search Engine:** Elasticsearch (전문 검색 및 형태소 분석)
- **Task Runner:** Prefect (후처리 작업 파이프라인 관리)

---

## 2. 데이터 저장 구조

### 2.1 저장소 분할 전략

| 데이터 종류 | 저장소           | 관리 방식                       |
|--------|---------------|-----------------------------|
| 노트 본문  | 파일 시스템        | `.md` 파일 형식 (UTF-8)         |
| 변경 이력  | Git           | 커밋(Commit) 및 브랜치(Branch) 관리 |
| 메타데이터  | DB (SQLite)   | 제목, 작성자, 태그, 최신 커밋 해시       |
| 검색 인덱스 | Elasticsearch | 본문 텍스트 토큰화 및 색인             |

### 2.2 디렉토리 구조

```
/data/notes/
├── .git/               # Git Repository 정보
├── team_a/             # 팀별 디렉토리
│   ├── note_101.md     # 실제 노트 파일
│   └── note_102.md
└── attachments/        # 첨부파일 (UUID 기반 관리)
```

---

## 3. 핵심 로직: 저장 및 동시성 제어

사용자의 저장 요청 시 데이터 유실을 방지하기 위해 **낙관적 잠금(Optimistic Locking)**과 Git Merge 메커니즘을 사용합니다.

### 3.1 저장 프로세스

1. **조회:** 사용자가 편집 시점의 `base_commit_hash`를 함께 전송
2. **비교:** DB의 최신 `last_commit_hash`와 사용자의 `base_commit_hash` 비교
3. **병합:**
    - 두 해시가 다를 경우 `git merge-file` 실행
    - **자동 병합 성공:** 병합된 내용으로 커밋 진행
    - **충돌 발생:** 충돌 표시(`<<<<`)가 포함된 내용을 임시 브랜치에 저장 후 유저에게 에러 응답
4. **확정:** 최종 결과물을 main 브랜치에 커밋하고 DB 갱신

---

## 4. 백그라운드 태스크 (Prefect)

사용자 응답 속도를 극대화하기 위해, 저장이 완료된 후의 후속 작업은 Prefect가 비동기로 처리합니다.

**Flow 명칭:** `post_save_indexing_flow`

**주요 Task:**

- `git_push_to_remote`: (필요 시) 내부 백업 레포지토리로 푸시
- `update_es_index`: Elasticsearch에 변경된 본문 색인 업데이트
- `notify_team`: 웹소켓 등을 통해 팀원들에게 업데이트 알림 전송

---

## 5. 데이터베이스 스키마 (SQLite 기준)

```sql
-- 노트 메타데이터 테이블
CREATE TABLE notes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    file_path TEXT UNIQUE NOT NULL,
    last_commit_hash TEXT,        -- Git 이력 추적용 (SHA-1)
    owner_id INTEGER,
    team_id INTEGER,
    is_conflicting INTEGER DEFAULT 0, -- 1: 충돌 해결 필요 상태
    tags TEXT,                    -- 콤마 분리형 또는 JSON 문자열
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 사용자 관리 (PoC용)
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE,
    email TEXT
);
```

---

## 6. 향후 확장 계획

- **DB 마이그레이션:** PoC 완료 후 SQLAlchemy 설정을 변경하여 PostgreSQL 또는 Oracle로 전환
- **검색 고도화:** Elasticsearch에 Nori 한글 형태소 분석기를 적용하여 검색 정확도 향상
- **실시간 협업:** 웹소켓을 도입하여 충돌 발생 전 다른 유저가 수정 중임을 알리는 '편집 중' 상태 표시 기능 추가